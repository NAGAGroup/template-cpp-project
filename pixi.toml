[workspace]
authors = ["Jack Myers <jackhmyers97@gmail.com>"]
channels = ["conda-forge"]
name = "template-project-cpp"
platforms = ["win-64", "linux-64"]
preview = ["pixi-build"]

# ======= Package Configuration (pixi-build) =======
# This enables `pixi build` and `pixi global install .`
# Uses the rattler-build backend with recipe/recipe.yaml
[package]
name = "template-cpp-project"
version = "0.1.0"

[package.build]
backend = { name = "pixi-build-rattler-build", version = "*" }
# Note: All package dependencies (host, build, run) come from recipe/recipe.yaml

# ======= Alternative Toolchain Builds =======
# The default `pixi build` uses Clang (via recipe/variants.yaml)
# For other toolchains, build with rattler-build directly:
#
#   rattler-build build -r recipe/recipe.yaml --variant-config recipe/variants-linux-gcc.yaml
#   rattler-build build -r recipe/recipe.yaml --variant-config recipe/variants-win-msvc.yaml
#
# See recipe/README.md for full documentation.

# ======= Project Environment Variables =======
[activation.env]
PROJECT_ROOT = "$PIXI_PROJECT_ROOT"

[target.linux-64.activation.env]
INSTALL_RPATHS = "\\$ORIGIN;\\$ORIGIN/../lib;\\$ORIGIN/../lib64"


# ========= Shared Features ==========

# Common build tools for all development environments
[feature.build-tools.dependencies]
fmt = ">=11.0.2,<12"
cmake = ">=3.24,<4"
ninja = ">=1.12.1,<2"
git = ">=2.47.0,<3"
ccache = ">=4.10.1,<5"
pkg-config = ">=0.29.2,<0.30"
pkgconfig = ">=1.5.5,<2"
cmake-format = ">=0.6.13,<0.7"
nushell = ">=0.103,<1"

[feature.build-tools.target.linux-64.dependencies]
wget = ">=1.21.4,<2"

# Testing dependencies
[feature.test.dependencies]
catch2 = ">=3.7.1,<4"

# Extra dev tools (linting, docs, etc.)
[feature.dev-tools.dependencies]
cppcheck = ">=2.15.0,<3"
doxygen = ">=1.11.0,<2"

# Clang tools (clang-tidy, clangd, clang-format)
[feature.clang-tools.dependencies]
clang-format = ">=18,<19"
clang-tools = ">=18,<19"

# Project management tools
[feature.project-mgmt.dependencies]
ripgrep = ">=14.1.1,<15"


# ======= Build Tasks =======
[feature.build-tasks.tasks.configure]
cmd = "nu scripts/configure.nu"

[feature.build-tasks.tasks.build]
cmd = "nu scripts/build.nu"
depends-on = ["configure"]

[feature.build-tasks.tasks.install]
cmd = "nu scripts/install.nu"
depends-on = ["build"]

[feature.build-tasks.tasks.patch-rpaths]
cmd = "nu scripts/patch-rpaths.nu"
depends-on = ["install"]

[feature.project-mgmt.tasks]
change-project-name = "nu scripts/change-project-name.nu"


# ======= TOOLCHAIN FEATURES =======
# These match the variant files in recipe/

# ----- Linux + Clang -----
[feature.linux-clang]
platforms = ["linux-64"]

[feature.linux-clang.dependencies]
clang_linux-64 = ">=18,<19"
clangxx_linux-64 = ">=18,<19"

[feature.linux-clang.activation]
scripts = ["activation/linux.sh", "activation/clang.sh"]

# ----- Linux + GCC -----
[feature.linux-gcc]
platforms = ["linux-64"]

[feature.linux-gcc.dependencies]
gcc_linux-64 = ">=13.3.0,<14"
gxx_linux-64 = ">=13.3.0,<14"

[feature.linux-gcc.activation]
scripts = ["activation/linux.sh", "activation/gcc.sh"]

# ----- Windows + Clang -----
[feature.win-clang]
platforms = ["win-64"]

[feature.win-clang.dependencies]
clangdev = ">=18,<19"
clang_win-64 = ">=18,<19"
clangxx_win-64 = ">=18,<19"
# MSVC is needed for Windows SDK/libraries
vs2022_win-64 = ">=17.0"

[feature.win-clang.activation]
scripts = ["activation/clang.bat"]

# ----- Windows + MSVC -----
[feature.win-msvc]
platforms = ["win-64"]

[feature.win-msvc.dependencies]
vs2022_win-64 = ">=17.0"

[feature.win-msvc.activation]
scripts = ["activation/msvc.bat"]


# ======= DEVELOPMENT ENVIRONMENTS =======
# One environment per platform/toolchain combination
# Naming convention: dev-<platform>-<toolchain>

[feature.dev-common.activation.env]
INSTALL_PREFIX = "$CONDA_PREFIX"

# Linux + Clang (default for Linux development)
[environments.dev-linux-clang]
features = ["build-tools", "dev-tools", "clang-tools", "test", "linux-clang", "build-tasks", "dev-common"]

# Linux + GCC
[environments.dev-linux-gcc]
features = ["build-tools", "dev-tools", "clang-tools", "test", "linux-gcc", "build-tasks", "dev-common"]

# Windows + Clang (default for Windows development)
[environments.dev-win-clang]
features = ["build-tools", "dev-tools", "clang-tools", "test", "win-clang", "build-tasks", "dev-common"]

# Windows + MSVC
[environments.dev-win-msvc]
features = ["build-tools", "dev-tools", "test", "win-msvc", "build-tasks", "dev-common"]

# Convenience alias: 'dev' points to platform-appropriate Clang environment
[environments.dev]
features = ["build-tools", "dev-tools", "clang-tools", "test", "linux-clang", "win-clang", "build-tasks", "dev-common"]

# ======= OTHER ENVIRONMENTS =======

# User environment for consumers who just want to build/install
[environments.user]
features = ["build-tools", "linux-clang", "win-clang", "build-tasks"]

# Test-only environment (for CI)
[environments.test]
features = ["build-tools", "test", "linux-clang", "win-clang", "build-tasks"]

# Project management (renaming, etc.)
[environments.project-mgmt]
no-default-feature = true
features = ["project-mgmt"]
